<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="logo-peluqueria.webp" type="image/png">
    <title>THE OLD - Reservas</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root {
            --primary: #1a1a1a;
            --accent: #d4af37;
            --bg-overlay: rgba(0, 0, 0, 0.75);
            --success: #28a745;
            --error: #d9534f;
            --text: rgb(211, 211, 211);
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            color: #fff;
            background: linear-gradient(var(--bg-overlay), var(--bg-overlay)),
                url('https://images.unsplash.com/photo-1503951914875-452162b0f3f1?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .main-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 50px 20px;
        }

        .container {
            background: rgba(38, 38, 38, 0.98);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 450px;
            color: #333;
            backdrop-filter: blur(10px);
        }

        .container h2 {
            font-size: 2rem;
            font-family: 'Courier New', Courier, monospace;
            text-align: center;
            color: var(--accent);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        label {
            display: block;
            margin-top: 15px;
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            color: var(--text);
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            box-sizing: border-box;
            transition: 0.3s;
        }

        input:focus,
        select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 5px rgba(212, 175, 55, 0.3);
        }

        .grid-horarios {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .hora-btn {
            padding: 12px 5px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }

        .hora-btn.selected {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .hora-btn:disabled {
            background: #eee;
            color: #bbb;
            cursor: not-allowed;
        }

        /* Estilo para bloqueados por admin */
        .hora-btn.bloqueado-admin {
            background: #ffecb3;
            color: #8a6d3b;
            border: 1px solid #faebcc;
        }

        .btn-enviar {
            width: 100%;
            padding: 15px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.3s;
            margin-top: 10px;
        }

        .btn-enviar:hover:not(:disabled) {
            background: #000000;
            transform: translateY(-2px);
        }

        .btn-enviar:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .btn-ws-confirm {
            background: #25d366 !important;
            margin-bottom: 10px;
            text-decoration: none;
            display: inline-block;
            width: 100%;
            box-sizing: border-box;
            text-align: center;
        }

        #mensajeExito {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            color: #333;
        }

        .icon-check {
            font-size: 60px;
            color: var(--success);
            margin-bottom: 15px;
        }

        .aviso-cerrado {
            grid-column: span 3;
            text-align: center;
            color: #c62828;
            font-weight: bold;
            background: #ffebee;
            padding: 15px;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <div class="main-content">
        <div class="container">
            <h2>THE OLD</h2>
            <form id="reservaForm">
                <label>Nombre Completo</label>
                <input type="text" id="nombre" placeholder="Ej: Juan P√©rez" required>

                <label>Tel√©fono / WhatsApp</label>
                <input type="tel" id="telefono" placeholder="Ej: 3445------" required>

                <label>Servicio</label>
                <select id="servicioSelector" required>
                    <option value="">Cargando...</option>
                </select>

                <label>D√≠a</label>
                <select id="fechaSelector" required>
                    <option value="">-- Elige un d√≠a --</option>
                </select>

                <div id="areaHorarios" style="display:none;">
                    <label>Horas Disponibles</label>
                    <div id="gridHorarios" class="grid-horarios"></div>
                </div>

                <button type="submit" id="btnConfirmar" class="btn-enviar" disabled>CONFIRMAR CITA</button>
            </form>
        </div>
    </div>

    <div id="mensajeExito">
        <div class="modal-content">
            <div class="icon-check">‚úî</div>
            <h2>¬°Reserva Exitosa!</h2>
            <p id="resumenCita"></p>

            <a id="btnWsDuenio" href="#" target="_blank" class="btn-enviar btn-ws-confirm">
                ENVIAR COMPROBANTE POR WHATSAPP
            </a>

            <button class="btn-enviar" onclick="window.location.href='index.html'" style="background: #666;">
                VOLVER AL INICIO
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBBu0u1KIZtXS6JanjyZQuS7OJDEaPJbwE",
            authDomain: "peluqueria-3cfca.firebaseapp.com",
            databaseURL: "https://peluqueria-3cfca-default-rtdb.firebaseio.com",
            projectId: "peluqueria-3cfca",
            storageBucket: "peluqueria-3cfca.firebasestorage.app",
            appId: "1:918388907412:web:cd0698e4e2745126398381"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Bloqueo de seguridad por suscripci√≥n
        onValue(ref(db, 'configuracion/estadoSuscripcion'), (snapshot) => {
            if (snapshot.val() === "inactivo") {
                document.body.innerHTML = `
                    <div style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #0a0a0a; color: white; font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px;">
                        <h1 style="color: #d4af37; font-size: 2.5rem; letter-spacing: 2px;">SERVICIO SUSPENDIDO</h1>
                        <p style="font-size: 1.2rem; max-width: 500px; color: #ccc;">El periodo de prueba ha finalizado.</p>
                    </div>`;
                document.body.style.background = "#0a0a0a";
            }
        });

        const fechaSelector = document.getElementById('fechaSelector');
        const gridHorarios = document.getElementById('gridHorarios');
        const btnConfirmar = document.getElementById('btnConfirmar');
        const servicioSelector = document.getElementById('servicioSelector');
        let horaSeleccionada = null;

        const horariosSemana = ["09:00", "09:50", "10:40", "16:00", "16:50", "17:40", "18:30", "19:20", "20:10", "21:00"];
        const horariosSabado = ["09:00", "10:00", "11:00", "12:00", "13:00"];

        // Cargar precios barber√≠a
        onValue(ref(db, 'configuracion/precios'), (snap) => {
            const p = snap.val() || { pelo: 0, barba: 0, promo: 0 };
            servicioSelector.innerHTML = `
                <option value="">-- Elige un servicio --</option>
                <option value="Corte de Pelo">Corte de Pelo ($${p.pelo})</option>
                <option value="Corte de Barba">Corte de Barba ($${p.barba})</option>
                <option value="Promo Completa">Pelo y Barba ($${p.promo})</option>
            `;
        });

        const cargarSemana = () => {
            const hoy = new Date();
            fechaSelector.innerHTML = '<option value="">-- Elige un d√≠a --</option>';
            for (let i = 0; i < 7; i++) {
                const d = new Date();
                d.setDate(hoy.getDate() + i);
                if (d.getDay() === 0) continue; // Saltar domingo
                const isoLocal = d.toISOString().split('T')[0];
                const opt = document.createElement('option');
                opt.value = isoLocal;
                opt.dataset.numDia = d.getDay();
                opt.textContent = d.toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'short' }).toUpperCase();
                fechaSelector.appendChild(opt);
            }
        };
        cargarSemana();

        fechaSelector.onchange = (e) => {
            const fechaElegida = e.target.value;
            const numDia = e.target.options[e.target.selectedIndex].dataset.numDia;
            const ahora = new Date();
            const hoyIso = ahora.toISOString().split('T')[0];

            if (!fechaElegida) return;
            document.getElementById('areaHorarios').style.display = 'block';
            gridHorarios.innerHTML = '<p style="grid-column:span 3; text-align:center; color:#ccc;">Verificando disponibilidad...</p>';
            btnConfirmar.disabled = true;
            horaSeleccionada = null;

            const listaAUsar = (numDia == 6) ? horariosSabado : horariosSemana;

            // 1. CONSULTAR BLOQUEOS DEL ADMIN
            onValue(ref(db, `bloqueos/${fechaElegida}`), (snapBloqueos) => {
                const bloqueos = snapBloqueos.val() || {};

                if (bloqueos.todo_el_dia === true) {
                    gridHorarios.innerHTML = '<div class="aviso-cerrado">‚õî FECHA CERRADA POR EL LOCAL</div>';
                    return;
                }

                // 2. CONSULTAR RESERVAS DE CLIENTES
                onValue(ref(db, 'reservas/' + fechaElegida), (snapReservas) => {
                    const ocupados = snapReservas.val() || {};
                    gridHorarios.innerHTML = '';

                    listaAUsar.forEach(h => {
                        const btn = document.createElement('button');
                        btn.type = "button";
                        btn.className = "hora-btn";

                        const estaOcupado = ocupados[h.replace(':', '')];
                        const estaBloqueadoAdmin = bloqueos[h];

                        let yaPaso = false;
                        if (fechaElegida === hoyIso) {
                            const [horaH, minH] = h.split(':').map(Number);
                            if (horaH < ahora.getHours() || (horaH === ahora.getHours() && minH <= ahora.getMinutes())) {
                                yaPaso = true;
                            }
                        }

                        // PRIORIDAD DE ESTADOS
                        if (yaPaso) {
                            btn.disabled = true;
                            btn.textContent = h;
                            btn.style.textDecoration = "line-through";
                            btn.style.opacity = "0.5";
                        } else if (estaBloqueadoAdmin) {
                            btn.disabled = true;
                            btn.textContent = "No Disp.";
                            btn.classList.add("bloqueado-admin");
                        } else if (estaOcupado) {
                            btn.disabled = true;
                            btn.textContent = "Ocupado";
                        } else {
                            btn.textContent = h;
                            btn.onclick = () => {
                                document.querySelectorAll('.hora-btn').forEach(b => b.classList.remove('selected'));
                                btn.classList.add('selected');
                                horaSeleccionada = h;
                                btnConfirmar.disabled = false;
                            };
                        }
                        gridHorarios.appendChild(btn);
                    });
                });
            });
        };

        document.getElementById('reservaForm').onsubmit = async (e) => {
            e.preventDefault();
            const fecha = fechaSelector.value;
            const nombre = document.getElementById('nombre').value;
            const telefono = document.getElementById('telefono').value;
            const servicio = servicioSelector.value;

            const horaID = horaSeleccionada.replace(':', '');
            const reservaRef = ref(db, `reservas/${fecha}/${horaID}`);

            btnConfirmar.disabled = true;
            btnConfirmar.innerText = "VERIFICANDO...";

            try {
                // Doble check antes de guardar
                const snapReserva = await get(reservaRef);
                const snapBloqueo = await get(ref(db, `bloqueos/${fecha}/${horaSeleccionada}`));
                const snapBloqueoDia = await get(ref(db, `bloqueos/${fecha}/todo_el_dia`));

                if (snapReserva.exists() || snapBloqueo.exists() || snapBloqueoDia.exists()) {
                    alert("‚ö†Ô∏è ¬°Uuups! Este horario ya no est√° disponible. Por favor elige otro.");
                    location.reload();
                    return;
                }

                await set(reservaRef, {
                    cliente: nombre,
                    telefono: telefono,
                    hora: horaSeleccionada,
                    servicio: servicio
                });

                // Link de WhatsApp
                const numDuenio = "3445411318";
                const mensajeWs = `Hola!%20Soy%20${nombre},%20acabo%20de%20reservar%20un%20turno:%0AüìÖ%20D√≠a:%20${fecha}%0Aüïí%20Hora:%20${horaSeleccionada}%0A‚úÇÔ∏è%20Servicio:%20${servicio}`;

                document.getElementById('btnWsDuenio').href = `https://wa.me/${numDuenio}?text=${mensajeWs}`;

                document.getElementById('resumenCita').innerHTML = `Turno para <b>${servicio}</b> agendado el <b>${fecha}</b> a las <b>${horaSeleccionada}</b>`;
                document.getElementById('mensajeExito').style.display = 'flex';

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
                btnConfirmar.disabled = false;
                btnConfirmar.innerText = "CONFIRMAR CITA";
            }
        };
    </script>
</body>

</html>